name: SonarQube Cloud Code Coverage Analysis

on:
  push:
    branches:
      - main
      - develop
      - release
  pull_request:
    branches:
      - main
      - develop

jobs:
  sonarqube-analysis:
    name: SonarQube Cloud Analysis with Code Coverage
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout source code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Disable shallow cloning for better analysis

      # Step 2: Setup .NET runtime
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # Step 3: Restore dependencies
      - name: Restore Dependencies
        run: dotnet restore

      # Step 4: Build solution
      - name: Build Solution
        run: dotnet build --configuration Release --no-restore

      # Step 5: Run tests with code coverage
      - name: Run Unit Tests with Coverage
        run: |
          dotnet test \
            --configuration Release \
            --no-build \
            --logger "trx;LogFileName=test-results.trx" \
            --collect:"XPlat Code Coverage" \
            --settings "src/AspireKeyCloakTemplate.Gateway.UnitTests/.runsettings" \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=opencover

      # Step 6: Install SonarQube Scanner for .NET
      - name: Install SonarQube Scanner
        run: |
          dotnet tool update dotnet-sonarscanner --global

      # Step 7: Begin SonarQube analysis
      - name: Begin SonarQube Analysis
        run: |
          dotnet sonarscanner begin \
            /k:${{ secrets.SONAR_PROJECT_KEY }} \
            /o:${{ secrets.SONAR_ORGANIZATION }} \
            /d:sonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            /d:sonar.login=${{ secrets.SONAR_TOKEN }} \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"

      # Step 8: Build for analysis (second build pass for SonarQube analysis)
      - name: Build for SonarQube Analysis
        run: dotnet build --configuration Release --no-restore

      # Step 9: End SonarQube analysis and upload results
      - name: End SonarQube Analysis
        run: |
          dotnet sonarscanner end /d:sonar.login=${{ secrets.SONAR_TOKEN }}

      # Step 10: Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'

      # Step 11: Publish coverage reports
      - name: Publish Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: '**/coverage.opencover.xml'

